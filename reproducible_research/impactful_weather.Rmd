High Impact Weather Events
========================================================

## Synopsis
TODO - describe and summarize findings

Limited collection before 1995: http://www.ncdc.noaa.gov/stormevents/details.jsp

Discuss:
* Determination of what damage and health effects are (ex. fatalities vs injuries)
* Change in data beginning 1995 and possibly show graph
* Event type Total vs average vs biggest individual events (>= 95%)
* Graphics
    + barchart of top 5 in each
    + 

## Data Processing
Read in the b2zip Data
```{r, cache=TRUE}
# Abount 410 Mb in size once read in, 902297 rows
# zz <- bfile("StormData.csv.bz2", "r")
if (file.exists("Stormdata.csv")) {
    df2 <- read.csv("StormData.csv", nrows=903000, strip.white=TRUE)
} else if (file.exists("StormData.csv.bz2")) {
    df2 <- read.csv(bzfile("StormData.csv.bz2"),nrows=903000, strip.white=TRUE)
} else {
    stop("File not Found: Please download the StormData.csv.bz2 file.")
}


# Create smaller data frame and release rest of original data
df2 <- subset(df2, select=c(BGN_DATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP,CROPDMG,CROPDMGEXP,F,MAG))
#rm(data)
```

Summarize data along the lines
* Affects on humnan health - FATALITIES and INJURIES  for each EVTYPE
* Economic effects - PROPDMG, CROPDMG for each EVTYPE, look at PROPDMGEXP and CROPDMGEXP which look like give units (ex. K)
* Mean damage by type
* Look at linear model (scatterplot?)
* Remove "summary: text" EVTYPES - followed by lines with data
* Identify highest impact events and use them to see if there is a difference

Create a function to compute the damage amounts
```{r}
dmgcalc <- function(base, exp) {
    ifelse(exp == "H" | exp == "h", base * 100,
    ifelse(exp == "K" | exp == "k", base * 1000,
    ifelse(exp == "M" | exp == "m", base * 1000000,
    ifelse(exp == "B" | exp == "b", base * 1000000000,
    ifelse(grepl("[0,9]*[.]*[0-9]",exp), base * 10^as.numeric(exp), 0
    )))))
}
```


Compute total values to be used in summary calculations
```{r}
# Load library that will be used to trim spaces on the EVTYPE variable
library(stringr)

#df2$date <- as.Date(df2$BGN_DATE,"%m/%d/%Y")
#df2$year <- as.character(df2$date, format="%Y")
df2 <- within(df2, {
    PROPDMGEXP <- as.character(PROPDMGEXP)
    CROPDMGEXP <- as.character(CROPDMGEXP)
    date <- as.Date(BGN_DATE,"%m/%d/%Y")
    year <- as.character(date, format="%Y")
    proptot <- dmgcalc(PROPDMG, PROPDMGEXP)
    croptot <- dmgcalc(CROPDMG, CROPDMGEXP)
    totaldmg <- proptot + croptot
    healthcomp <- INJURIES + FATALITIES
    EVTYPE <- str_trim(as.character(EVTYPE))
    EVTYPE <- as.factor(EVTYPE)
})



# Only look at records from 1993 onward for property damage. Prior to this only Tornados, Thunderstorm, and Hail damage were recorded.
# All the 100 largest damages occur from 1993 onward.
# post1992 <- subset(df2, year > 1992)


# Create column for year and populte based on BGN_DATE
library(plyr)


## Need to combine tornadoes, hurricanes, winds, heat, tropical storms, cold, rain,
# Should we colapse tropical events (hurricane, typhoon, tropical storm, storm surge) into a single type?
# Is hail part of thungerstorm?
df2$EVTYPE2 <- df2$EVTYPE
source("cleantypes.R")

df2$EVTYPE <- cleantypes(df2$EVTYPE)
# summarize by type
yearly.prop.dmg <- ddply(df2, .(year, EVTYPE), summarize, propertydamage=sum(totaldmg))
yearly.rollup <- ddply(yearly.prop.dmg, .(year), summarize, propdmg=sum(propertydamage))


typesummary <- ddply(df2, ~EVTYPE, summarize, prop=sum(proptot), avgprop=mean(proptot), 
                     crop=sum(croptot), avgcrop=mean(croptot),
                     damage=sum(totaldmg), avgdamage=mean(totaldmg),
                     fatal=sum(FATALITIES), avgfatal=round(mean(FATALITIES),0), 
                     injury=sum(INJURIES), avginjury=round(mean(INJURIES),0),
                     health=sum(healthcomp), avghealth=round(mean(healthcomp),0)
                     ) 
# Only look at records from 1993 onward. Prior to this only Tornados, Thunderstorm, and Hail damage were recorded.
# All the largest damages occur from 1993 onward. NOTE: if taking more than top 100 then pre 1993 instances occur.


# Remove all the records have no damage, injuries, or deaths
typesummary <- subset(typesummary, damage > 0 | health > 0)
typesummary <- droplevels(typesummary)
# Function to extract the top 10 values from a data frame based on the passed column
topvals <- function(df, col, num) {
    if (is.character(col)) {
        colnum <- which (colnames(df) == col)
    } else {
        colnum <- col
    }
    
    top <- with(df, df[order(-df[colnum])[1:num],])
    top
}

# 10 types events with highest average property damage
bprop <- topvals(typesummary, "prop", 10)
bavgprop <- topvals(typesummary, "avgprop", 10)
btot <- topvals(typesummary, "damage", 10)
bavgtot <- topvals(typesummary, "avgdamage", 10)
bfatal <- topvals(typesummary, "fatal", 10)
avgfatal <- topvals(typesummary, "avgfatal", 10)
health <- topvals(typesummary, "health", 10)
avghealth <- topvals(typesummary, "avghealth",10)

# get average damage
avgdmg <- mean(yearly.prop.dmg$propertydamage)
sd <- sd(yearly.prop.dmg$propertydamage)
# example to select 500 highest
#bigprop <- df2[with(df2, order(-proptot)[1:500]),]
#bigfatal <- df2[with(df2, order(-FATALITIES)[1:500]),]
#biginjury <- df2[with(df2, order(-INJURIES)[1:500]),]
#ggplot(yearly.prop.dmg[yearly.prop.dmg$propertydamage > avgdmg + 2*sd,], aes(x=EVTYPE,y=propertydamage)) + #geom_boxplot()
```

Graphs to look at:
* Across time
* By event type
* Subsetting of health and damage components
* By geo area (time permitting)
* By month (time permitting)

## Results

You can also embed plots, for example:dt


```{r fig.width=7, fig.height=6}
#plot(cars)
# Graph to look at distribution for events > 1 std adn > 2 std
# ggplot(yearly.prop.dmg[yearly.prop.dmg$propertydamage > avgdmg + sd,], aes(x=EVTYPE,y=propertydamage)) + geom_boxplot()
# ggplot(yearly.prop.dmg[yearly.prop.dmg$propertydamage > avgdmg + 2*sd,], aes(x=EVTYPE,y=propertydamage)) + geom_boxplot()
```

